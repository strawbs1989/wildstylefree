<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wildstyle Community Forums</title>
  <meta name="description" content="Wildstyle.vip Community Forums ‚Äî Unsigned Artists, Music Chat, Tech Help" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">



  <style>
    :root{
      --bg:#0b0b0f;           /* Wildstyle dark */
      --panel:#12121a;        /* Card background */
      --muted:#9aa0a6;        /* Muted text */
      --accent:#ff2a2a;       /* Wildstyle neon red */
      --accent-2:#f54774;     /* secondary glow */
      --ring: rgba(255, 42, 42, .35);
      --ok:#34d399; --warn:#f59e0b; --danger:#ef4444;
      --radius:18px;
      --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(800px 500px at 10% -10%, rgba(255, 42, 42, .07), transparent 60%),
        radial-gradient(800px 500px at 110% 10%, rgba(245, 71, 116, .07), transparent 60%),
        var(--bg);
      color:#e8eaed;
    }
    header{
      position:sticky; top:0; z-index:50; backdrop-filter:saturate(1.1) blur(6px);
      background:linear-gradient(180deg, rgba(11,11,15,.9), rgba(11,11,15,.6));
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .nav{ display:flex; gap:14px; align-items:center; padding:14px 18px; max-width:1200px; margin:0 auto }
    .brand{ display:flex; gap:12px; align-items:center }
    .brand img{ width:40px; height:40px; border-radius:10px; box-shadow:0 0 18px var(--ring) }
    .brand h1{ font-size:18px; margin:0; letter-spacing:.6px }
    .brand small{ color:var(--muted) }
    .grow{ flex:1 }
    .search{ position:relative; width: min(520px, 100%) }
    .search input{
      width:100%; padding:12px 40px 12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.08);
      background:#0f0f15; color:#e8eaed; outline:none; box-shadow: inset 0 0 0 1px transparent, var(--shadow);
    }
    .search svg{ position:absolute; right:10px; top:50%; transform:translateY(-50%); opacity:.8 }
    .btn{ background:var(--accent); color:white; border:none; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; box-shadow:0 6px 18px rgba(255,42,42,.25) }
    .btn.ghost{ background:transparent; border:1px solid rgba(255,255,255,.12) }

    main{ max-width:1200px; margin:24px auto; padding:0 18px; display:grid; grid-template-columns: 280px 1fr; gap:18px }

    aside{ position:sticky; top:80px; align-self:start; background:var(--panel); border:1px solid rgba(255,255,255,.06); border-radius:var(--radius); box-shadow:var(--shadow) }
    .aside-head{ padding:16px 16px 8px; border-bottom:1px solid rgba(255,255,255,.06) }
    .cats{ padding:8px }
    .cat{ display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; cursor:pointer }
    .cat[aria-current="true"], .cat:hover{ background:rgba(255,42,42,.08); box-shadow: inset 0 0 0 1px rgba(255,42,42,.2) }
    .cat small{ color:var(--muted) }

    .toolbar{ display:flex; align-items:center; gap:10px; padding:14px; background:var(--panel); border:1px solid rgba(255,255,255,.06); border-radius:var(--radius); box-shadow:var(--shadow) }

    .threads{ display:grid; gap:14px; margin-top:14px }
    .card{ background:var(--panel); border:1px solid rgba(255,255,255,.06); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden }
    .card .row{ display:flex; gap:14px; padding:14px }
    .thumb{ width:120px; height:120px; object-fit:cover; border-radius:12px; box-shadow:0 0 0 1px rgba(255,255,255,.08) }
    .meta{ display:flex; gap:10px; align-items:center; color:var(--muted); font-size:12px }
    .badge{ padding:2px 8px; border-radius:999px; font-size:11px; font-weight:800; letter-spacing:.4px; border:1px solid rgba(255,255,255,.12) }
    .badge.dj{ color:white; background:linear-gradient(90deg, var(--accent), var(--accent-2)); box-shadow:0 0 14px var(--ring) }
    .badge.staff{ background:#0f172a; color:#a5b4fc; border-color:#3b82f6 }
    .actions{ display:flex; gap:8px; margin-left:auto }
    .action{ background:transparent; border:1px solid rgba(255,255,255,.12); color:#e8eaed; padding:6px 10px; border-radius:10px; cursor:pointer }
    .action.like[aria-pressed="true"]{ border-color:var(--accent); box-shadow:0 0 0 2px rgba(255,42,42,.2) inset }
    .action.pin[aria-pressed="true"]{ border-color:#fde047; box-shadow:0 0 0 2px rgba(253,224,71,.2) inset }

    .replies{ border-top:1px solid rgba(255,255,255,.06); padding:12px 14px; background:rgba(255,255,255,.01) }
    .reply{ display:grid; grid-template-columns: 44px 1fr; gap:10px; padding:10px 0; border-bottom:1px dashed rgba(255,255,255,.06) }
    .reply:last-child{ border-bottom:none }
    .avatar{ width:44px; height:44px; border-radius:10px; background:#0f0f15; display:flex; align-items:center; justify-content:center; color:var(--muted); border:1px solid rgba(255,255,255,.06) }
    .reply img.embedded{ max-width:100%; border-radius:10px; border:1px solid rgba(255,255,255,.06); margin-top:8px }

    .compose{ display:grid; grid-template-columns: 1fr 1fr auto; gap:10px; padding:12px 14px; background:#0f0f15; border-top:1px solid rgba(255,255,255,.06) }
    .compose input, .compose textarea{
      background:#0b0b10; color:#e8eaed; border:1px solid rgba(255,255,255,.08); border-radius:10px; padding:10px; outline:none
    }
    .compose textarea{ grid-column: 1 / -1; min-height:80px; resize:vertical }

    dialog.modal{ border:none; border-radius:20px; padding:0; background:var(--panel); color:#e8eaed; width:min(720px, calc(100% - 24px)); box-shadow: var(--shadow) }
    .modal header{ padding:16px 18px; border-bottom:1px solid rgba(255,255,255,.06); display:flex; align-items:center; gap:10px }
    .modal .content{ padding:16px 18px; display:grid; gap:12px }
    .modal label{ font-size:13px; color:var(--muted) }
    .modal input, .modal textarea, .modal select{ width:100%; background:#0b0b10; color:#e8eaed; border:1px solid rgba(255,255,255,.08); border-radius:10px; padding:10px; outline:none }

    .empty{ text-align:center; color:var(--muted); padding:60px 20px }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:rgba(255,42,42,.12); border:1px solid rgba(255,42,42,.25) }

    @media (max-width: 920px){ main{ grid-template-columns: 1fr } aside{ position:static } .thumb{ width:86px; height:86px } }
  </style>
</head>
<body>
  <header>
    <nav class="nav">
      <div class="brand">
        <img src="/test1/placeholder.png" alt="Wildstyle logo">
        <div>
          <h1>Wildstyle Forums</h1>
          <small>United by Beats ‚Ä¢ Powered by Passion</small>
        </div>
      </div>
      <div class="grow"></div>
      <div class="search">
        <input id="searchInput" type="search" placeholder="Search threads‚Ä¶" aria-label="Search threads" />
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M21 21l-4.35-4.35" stroke="#9aa0a6" stroke-width="1.5" stroke-linecap="round"/><circle cx="11" cy="11" r="6.5" stroke="#9aa0a6" stroke-width="1.5"/></svg>
      </div>
      <button id="loginBtn" class="btn">Log in / Sign up</button>
      <button id="logoutBtn" class="btn ghost" style="display:none">Log out</button>
    </nav>
  </header>

  <main>
    <aside>
      <div class="aside-head">
           <!-- Now Playing Script -->
<script>
const DH = Array.from({ length: 7 }, () => Array(24).fill(null))

// MONDAY
DH[1][10] = { show: "10am ‚Äì 12pm<br>DJ Mark", duration: 2 }
DH[1][12] = { show: "7am ‚Äì 8am<br>DJ Keeks", duration: 2 }
DH[1][12] = { show: "12pm ‚Äì 2pm<br>James-Wizard Of Rock", duration: 2 }
DH[1][14] = { show: "2pm ‚Äì 4pm<br>BabyJane", duration: 2 }
DH[1][15] = { show: "3pm ‚Äì 5pm<br>James Stephen", duration: 2 }
DH[1][17] = { show: "5pm ‚Äì 7pm<br>Lewis", duration: 2 }
DH[1][19] = { show: "7pm ‚Äì 10pm<br>DJ Dezzy ‚Äì Mix Set", duration: 3 }
DH[1][22] = { show: "10pm ‚Äì 12am<br>DJ Jayden Mac ‚Äì Grime", duration: 2 }

// TUESDAY
DH[2][1] = { show: "1am ‚Äì 2am<br>James - Wizard Of Rock", duration: 1 }
DH[2][3] = { show: "3am ‚Äì 6am<br>Dani - DJ Queen Dani", duration: 3 }
DH[2][6] = { show: "6am ‚Äì 8am<br>Auto", duration: 2 }
DH[2][15] = { show: "3pm ‚Äì 5pm<br>James Stephen", duration: 2 }
DH[2][15] = { show: "6pm ‚Äì 8pm<br>DJ Squeek", duration: 2 }
DH[2][20] = { show: "8pm ‚Äì 10pm<br>Dj Lewis", duration: 2 }
DH[2][10] = { show: "10am ‚Äì 12pm<br>HothotDJ", duration: 2 }

// WEDNESDAY
DH[3][10] = { show: "10am ‚Äì 12pm<br>DJ Mark", duration: 2 }
DH[3][15] = { show: "3pm ‚Äì 5pm<br>DJ Dezza", duration: 2 }
DH[3][18] = { show: "6pm ‚Äì 7pm<br>Auto", duration: 1 }
DH[3][20] = { show: "8pm ‚Äì 10pm<br>Steve DJ Smith", duration: 2 }
DH[3][22] = { show: "10pm ‚Äì 12am<br>Reece", duration: 2 }

// THURSDAY
DH[4][8] = { show: "8am ‚Äì 10am<br>Coll", duration: 2 }
DH[4][0] = { show: "12am ‚Äì 4am<br>Auto", duration: 4 }
DH[4][10] = { show: "10am ‚Äì 12pm<br>Gordan", duration: 2 }
DH[4][15] = { show: "3pm ‚Äì 4pm<br>DJ Dezza", duration: 1 }
DH[4][19] = { show: "7pm ‚Äì 8pm<br>Echofalls(DJ Strawbs)", duration: 1 }
DH[4][20] = { show: "8pm ‚Äì 10pm<br>Russ", duration: 2 }
DH[4][22] = { show: "10pm ‚Äì 11pm<br>MottMuzik", duration: 1 }

// FRIDAY
DH[5][0] = { show: "12am ‚Äì 4am<br>SteveG", duration: 4 }
DH[5][10] = { show: "10am ‚Äì 12pm<br>Vish", duration: 2 }
DH[5][15] = { show: "3pm ‚Äì 5pm<br>James Stephen", duration: 2 }
DH[5][16] = { show: "4pm ‚Äì 8pm<br>StevenD", duration: 4 }
DH[5][20] = { show: "8pm ‚Äì 10pm<br>Wendall", duration: 2 }
DH[5][22] = { show: "10pm ‚Äì 11pm<br>Rebecca - DJ Mix&Match", duration: 1 }

// SATURDAY
DH[6][0] = { show: "12am ‚Äì 2am<br>Auto", duration: 2 }
DH[6][2] = { show: "2am ‚Äì 4am<br>DJ AJ", duration: 2 }
DH[6][16] = { show: "4pm ‚Äì 6pm<br>The Byrdman", duration: 2 }
DH[6][18] = { show: "6pm ‚Äì8pm<br>DJ LiL Devil", duration: 2 }
DH[6][19] = { show: "7pm ‚Äì 8pm<br>Sonic-Recorded", duration: 1 }
DH[6][6] = { show: "6am ‚Äì 10am<br>Cam", duration: 4 }
DH[6][10] = { show: "10am ‚Äì 12pm<br>DJ Nero", duration: 2 }
DH[6][20] = { show: "8pm ‚Äì 9pm<br>Daniel", duration: 1 }

// SUNDAY
DH[0][8] = { show: "8am ‚Äì 10am<br>Auto", duration: 2 }
DH[0][11] = { show: "11am ‚Äì 12pm<br>HotShot - 80's 90's", duration: 1 }
DH[0][12] = { show: "12pm ‚Äì 1pm<br>Dutch", duration: 1 }
DH[0][13] = { show: "1pm ‚Äì 3pm<br>JK", duration: 2 }
DH[0][15] = { show: "3pm ‚Äì 5pm<br>DJ Fraser", duration: 2 }
DH[0][17] = { show: "5pm ‚Äì 7pm<br>DJ Lewis", duration: 2 }
DH[0][19] = { show: "7pm - 8pm<br>Auto", duration: 1 }
DH[0][20] = { show: "8pm - 9pm<br>BIG BOSS Dj Echofalls", duration: 1 }
DH[0][21] = { show: "9pm - 12am<br>Popped Radio", duration: 3 }

function NowON() {
  const now = new Date()
  const ukTime = new Date(now.toLocaleString('en-US', { timeZone: 'Europe/London' }))
  const localHour = ukTime.getHours()
  const day = ukTime.getDay()
  const prevDay = (day - 1 + 7) % 7
 
  const isInShow = (startHour, slot, hour) => {
    const start = parseInt(startHour)
    const end = (start + slot.duration) % 24
    return start <= hour && hour < end || (end < start && (hour >= start || hour < end))
  }
 
  // Check current day's shows
  const currentShow = Object.entries(DH[day])
    .filter(([, slot]) => slot !== null)
    .find(([startHour, slot]) => isInShow(startHour, slot, localHour))
 
  // If no show found, check if a show from previous day is still running
  const prevDayShow = !currentShow ? Object.entries(DH[prevDay])
    .filter(([, slot]) => slot !== null)
    .find(([startHour, slot]) => {
      const start = parseInt(startHour)
      const end = start + slot.duration
      return end >= 24 && localHour < end - 24
    }) : null
 
  const show = (currentShow?.[1] || prevDayShow?.[1])?.show || "üïì Off Air<br>No current broadcast."
  document.getElementById("NowOn").innerHTML = show
}

// Optional: auto-refresh every 60 seconds
setInterval(NowON, 60000);</script>
</head>

<body onload="NowON()">
  <div id="NowOn" style="font-weight:bold;color:#fff;text-align:center;"></div>
      </div>
      <div class="cats" id="cats">
        <!-- Categories injected here -->
      </div>
    </aside>

    <section>
      <div class="toolbar">
        <div id="activeCatLabel"><strong>All</strong> threads</div>
        <div class="grow"></div>
        <button id="newThreadBtn" class="btn">‚ûï New Thread</button>
      </div>
      <div id="threads" class="threads"></div>
      <div id="empty" class="empty" style="display:none">No threads yet in this category. Be the first to post! üëá</div>
    </section>
  </main>

  <!-- New Thread Modal -->
  <dialog id="threadModal" class="modal">
    <header>
      <strong>Create a new thread</strong>
      <div class="grow"></div>
      <button class="action" onclick="document.getElementById('threadModal').close()">‚úñ</button>
    </header>
    <div class="content">
      <div>
        <label>Category</label>
        <select id="threadCat">
          <option value="unsigned">Unsigned Artists</option>
          <option value="music">Music Chat</option>
          <option value="tech">Tech Help</option>
		  <option value="tech">General</option>
        </select>
      </div>
      <div>
        <label>Title</label>
        <input id="threadTitle" placeholder="Make it descriptive" maxlength="120" />
      </div>
      <div>
        <label>Image URL (required, images only)</label>
        <input id="threadImage" placeholder="https://‚Ä¶ .jpg .png .gif (no video)" />
      </div>
      <div>
        <label>Body (text only ‚Äî images are embedded via the Image URL field)</label>
        <textarea id="threadBody" placeholder="Say something about your image‚Ä¶ (no links/scripts)"></textarea>
      </div>
      <div style="display:flex; gap:10px; justify-content:flex-end">
        <button class="btn ghost" onclick="document.getElementById('threadModal').close()">Cancel</button>
        <button id="createThread" class="btn">Create Thread</button>
      </div>
    </div>
  </dialog>

  <!-- Login Modal -->
  <dialog id="authModal" class="modal">
    <header>
      <strong>Welcome to Wildstyle Forums</strong>
      <div class="grow"></div>
      <button class="action" onclick="document.getElementById('authModal').close()">‚úñ</button>
    </header>
    <div class="content">
      <p style="color:var(--muted); margin:0">Log in or create an account to post, reply, and like.</p>
      <div style="display:grid; gap:10px; grid-template-columns: 1fr 1fr">
        <div>
          <label>Email</label>
          <input id="authEmail" type="email" placeholder="you@example.com" />
        </div>
        <div>
          <label>Password</label>
          <input id="authPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>
      </div>
      <div>
        <label>Display name (for new accounts)</label>
        <input id="authName" placeholder="DJ EchoFalls" />
      </div>
      <div style="display:flex; gap:10px; justify-content:flex-end">
        <button id="doLogin" class="btn">Log in</button>
        <button id="doSignup" class="btn ghost">Sign up</button>
      </div>
    </div>
  </dialog>

  <script type="module">
    // =====================
    //  Firebase CONFIG üîß
    // =====================
    const firebaseConfig = {
  apiKey: "AIzaSyC6c26rAeeCZZKgVMqhXbn1b-s8kdQRmQY",
  authDomain: "forums-4ede0.firebaseapp.com",
  projectId: "forums-4ede0",
  storageBucket: "forums-4ede0.firebasestorage.app",
  messagingSenderId: "773264522533",
  appId: "1:773264522533:web:bbd91d96b025f31f10eecc",
  measurementId: "G-D83TTX3JJT"
};

    // =====================
    //  Imports (v10 CDN)
    // =====================
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, collection, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, serverTimestamp, query, where, orderBy, limit, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // =====================
    //  Wildstyle theme bits
    // =====================
    const CATEGORIES = [
      { id:'all', label:'All' },
      { id:'unsigned', label:'Unsigned Artists' },
      { id:'music', label:'Music Chat' },
      { id:'tech', label:'Tech Help' },
    ];

    const state = {
      user:null,
      roles:[],
      activeCat:'all',
      unsubscribe:null,
      threads:[],
      search:''
    };

    const el = (sel) => document.querySelector(sel);
    const els = (sel) => Array.from(document.querySelectorAll(sel));

    // Seed categories UI
    const catsBox = el('#cats');
    CATEGORIES.forEach(c => {
      const div = document.createElement('div');
      div.className = 'cat';
      div.setAttribute('data-cat', c.id);
      if(c.id==='all') div.setAttribute('aria-current','true');
      div.innerHTML = `<strong>${c.label}</strong>`;
      div.addEventListener('click', ()=> switchCategory(c.id));
      catsBox.appendChild(div);
    });

    function isImageUrl(u){
      try{
        const url = new URL(u);
        return /(\.png|\.jpg|\.jpeg|\.gif|\.webp)$/i.test(url.pathname);
      }catch{ return false }
    }

    function sanitize(text){
      // Strip HTML/script; allow plain text only (images come from validated field)
      return String(text||'').replace(/[\u0000-\u001F\u007F-\u009F]/g,'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function hasRole(r){ return state.roles.includes(r); }

    async function loadRoles(uid){
      state.roles = [];
      if(!uid) return;
      const snap = await getDoc(doc(db,'roles', uid));
      if(snap.exists()){
        const d = snap.data();
        state.roles = Array.isArray(d.roles) ? d.roles : [];
      }
    }

    function switchCategory(cat){
      state.activeCat = cat;
      els('.cat').forEach(n => n.setAttribute('aria-current', n.getAttribute('data-cat')===cat ? 'true' : 'false'));
      el('#activeCatLabel').innerHTML = `<strong>${CATEGORIES.find(x=>x.id===cat)?.label||'All'}</strong> threads`;
      bindThreadsListener();
    }

    function bindThreadsListener(){
      if(state.unsubscribe) state.unsubscribe();
      const base = collection(db,'threads');
      let qy;
      if(state.activeCat==='all'){
        qy = query(base, orderBy('pinned','desc'), orderBy('updatedAt','desc'), limit(100));
      }else{
        qy = query(base, where('category','==',state.activeCat), orderBy('pinned','desc'), orderBy('updatedAt','desc'), limit(100));
      }
      state.unsubscribe = onSnapshot(qy, (snap)=>{
        state.threads = snap.docs.map(d=> ({ id:d.id, ...d.data() }));
        renderThreads();
      });
    }

    function threadCard(t){
      const isOwner = state.user && t.authorUid === state.user.uid;
      const canMod = hasRole('admin') || hasRole('mod');
      const showStaff = canMod || isOwner;

      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `
        <div class="row">
          <img class="thumb" src="${isImageUrl(t.imageUrl) ? t.imageUrl : '/test1/placeholder.png'}" alt="thread image" />
          <div style="flex:1">
            <div class="meta">
              <span class="badge ${t.authorRoles?.includes('dj')?'dj':''}">${t.authorRoles?.includes('dj') ? 'DJ' : 'Member'}</span>
              <span title="Author">${t.authorName||'Unknown'}</span>
              <span>‚Ä¢</span>
              <span>${new Date(t.updatedAt?.toDate?.() || t.updatedAt || Date.now()).toLocaleString()}</span>
              ${t.pinned?'<span class="badge staff" title="Pinned">üìå Pinned</span>':''}
            </div>
            <h3 style="margin:6px 0 6px">${sanitize(t.title)}</h3>
            <p style="color:var(--muted); margin:0">${sanitize(t.body)}</p>
          </div>
          <div class="actions">
            <button class="action like" aria-pressed="false" data-like>‚ù§Ô∏è <span>${t.likesCount||0}</span></button>
            ${showStaff?`<button class="action pin" aria-pressed="${t.pinned?'true':'false'}" data-pin>üìå</button>`:''}
            ${(canMod || isOwner)?`<button class="action" data-edit>‚úèÔ∏è</button><button class="action" data-del>üóëÔ∏è</button>`:''}
          </div>
        </div>
        <div class="replies" data-replies></div>
        <div class="compose">
          <input data-reply-image placeholder="Image URL (required for embedded image)" />
          <input data-reply-text placeholder="Your message (text only)" />
          <button class="btn" data-reply>Reply</button>
          <textarea data-edit-body placeholder="Edit body‚Ä¶" style="display:none"></textarea>
        </div>
      `;

      // Likes
      div.querySelector('[data-like]')?.addEventListener('click', ()=> likeThread(t));

      // Pin, Edit, Delete
      const pinBtn = div.querySelector('[data-pin]');
      if(pinBtn){ pinBtn.addEventListener('click', ()=> togglePin(t)); }
      div.querySelector('[data-edit]')?.addEventListener('click', ()=> startEdit(div, t));
      div.querySelector('[data-del]')?.addEventListener('click', ()=> deleteThread(t));

      // Replies
      div.querySelector('[data-reply]')?.addEventListener('click', ()=> postReply(div, t));
      loadReplies(div, t.id);
      return div;
    }

    function renderThreads(){
      const box = el('#threads');
      box.innerHTML = '';
      const list = state.threads.filter(t=> !state.search || (t.title?.toLowerCase?.().includes(state.search) || t.body?.toLowerCase?.().includes(state.search)));
      if(list.length===0){ el('#empty').style.display='block'; return; } else { el('#empty').style.display='none'; }
      list.forEach(t => box.appendChild(threadCard(t)));
    }

    async function loadReplies(container, threadId){
      const repliesBox = container.querySelector('[data-replies]');
      repliesBox.innerHTML = '';
      const qy = query(collection(db,'threads', threadId, 'replies'), orderBy('createdAt','asc'), limit(50));
      const snap = await getDocs(qy);
      snap.forEach(d => {
        const r = d.data();
        const row = document.createElement('div');
        row.className = 'reply';
        row.innerHTML = `
          <div class="avatar">${(r.authorName||'?').slice(0,2).toUpperCase()}</div>
          <div>
            <div class="meta"><strong>${sanitize(r.authorName||'')}</strong> ‚Ä¢ ${new Date(r.createdAt?.toDate?.() || Date.now()).toLocaleString()}</div>
            <div>${sanitize(r.body||'')}</div>
            ${isImageUrl(r.imageUrl)?`<img class="embedded" src="${r.imageUrl}" alt="reply image" />`:''}
          </div>
        `;
        repliesBox.appendChild(row);
      });
    }

    async function postReply(container, t){
      if(!state.user){ return el('#authModal').showModal(); }
      const img = container.querySelector('[data-reply-image]').value.trim();
      const txt = sanitize(container.querySelector('[data-reply-text]').value.trim());
      if(!isImageUrl(img)){ alert('Replies must include a valid image URL (.png .jpg .jpeg .gif .webp).'); return; }
      await addDoc(collection(db,'threads', t.id, 'replies'), {
        imageUrl: img,
        body: txt,
        authorUid: state.user.uid,
        authorName: state.user.displayName || state.user.email,
        createdAt: serverTimestamp()
      });
      await updateDoc(doc(db,'threads', t.id), { updatedAt: serverTimestamp() });
      container.querySelector('[data-reply-image]').value='';
      container.querySelector('[data-reply-text]').value='';
      loadReplies(container, t.id);
    }

    async function likeThread(t){
      if(!state.user){ return el('#authModal').showModal(); }
      const likeRef = doc(db,'threads', t.id, 'likes', state.user.uid);
      const snap = await getDoc(likeRef);
      if(snap.exists()){
        // Unlike
        await deleteDoc(likeRef);
        await updateDoc(doc(db,'threads', t.id), { likesCount: (t.likesCount||0) - 1 });
      } else {
        await setDoc(likeRef, { createdAt: serverTimestamp() });
        await updateDoc(doc(db,'threads', t.id), { likesCount: (t.likesCount||0) + 1 });
      }
    }

    async function togglePin(t){
      if(!(hasRole('admin') || hasRole('mod'))){ return alert('Mods/admins only'); }
      await updateDoc(doc(db,'threads', t.id), { pinned: !t.pinned, updatedAt: serverTimestamp() });
    }

    function startEdit(container, t){
      const area = container.querySelector('[data-edit-body]');
      const editing = area.style.display !== 'none';
      if(!editing){
        area.style.display = 'block';
        area.value = t.body||'';
        const save = document.createElement('button');
        save.className = 'btn';
        save.textContent = 'Save';
        save.addEventListener('click', async ()=>{
          await updateDoc(doc(db,'threads', t.id), { body: sanitize(area.value), updatedAt: serverTimestamp() });
          area.style.display = 'none';
          bindThreadsListener();
        });
        area.after(save);
      } else {
        area.style.display = 'none';
      }
    }

    async function deleteThread(t){
      if(!(hasRole('admin') || hasRole('mod') || (state.user && t.authorUid===state.user.uid))){ return alert('No permission'); }
      if(!confirm('Delete this thread?')) return;
      await deleteDoc(doc(db,'threads', t.id));
    }

    // =====================
    //  Create Thread
    // =====================
    el('#newThreadBtn').addEventListener('click', ()=>{
      if(!state.user){ el('#authModal').showModal(); return; }
      el('#threadModal').showModal();
    });

    el('#createThread').addEventListener('click', async ()=>{
      const cat = el('#threadCat').value;
      const title = sanitize(el('#threadTitle').value.trim());
      const image = el('#threadImage').value.trim();
      const body = sanitize(el('#threadBody').value.trim());
      if(!title) return alert('Title required');
      if(!isImageUrl(image)) return alert('Image URL required (.png .jpg .jpeg .gif .webp only).');
      const docRef = await addDoc(collection(db,'threads'), {
        category: cat,
        title, body, imageUrl: image,
        authorUid: state.user.uid,
        authorName: state.user.displayName || state.user.email,
        authorRoles: state.roles,
        pinned:false, likesCount:0,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });
      el('#threadModal').close();
      switchCategory(cat);
    });

    // =====================
    //  Auth
    // =====================
    el('#loginBtn').addEventListener('click', ()=> el('#authModal').showModal());
    el('#logoutBtn').addEventListener('click', async ()=> { await signOut(auth); });

    el('#doLogin').addEventListener('click', async ()=>{
      try{
        const email = el('#authEmail').value.trim();
        const pass = el('#authPass').value;
        await signInWithEmailAndPassword(auth, email, pass);
        el('#authModal').close();
      }catch(e){ alert(e.message); }
    });
    el('#doSignup').addEventListener('click', async ()=>{
      try{
        const email = el('#authEmail').value.trim();
        const pass = el('#authPass').value;
        const name = el('#authName').value.trim();
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        if(name){ await updateProfile(cred.user, { displayName: name }); }
		
		// ‚úâÔ∏è Send verification email
    await sendEmailVerification(cred.user);
    alert("Verification email sent! Please check your inbox before logging in.");

    el('#authModal').close();
  } catch(e) {
    alert(e.message);
  }
}); 
        // default role: member; grant DJ/admin via roles collection (manual)
        el('#authModal').close();
      }catch(e){ alert(e.message); }
    });

    onAuthStateChanged(auth, async (user)=>{
      state.user = user || null;
      el('#logoutBtn').style.display = user? 'inline-flex':'none';
      el('#loginBtn').style.display = user? 'none':'inline-flex';
      await loadRoles(user?.uid);
      bindThreadsListener();
    });

    // =====================
    //  Search
    // =====================
    el('#searchInput').addEventListener('input', (e)=>{
      state.search = e.target.value.trim().toLowerCase();
      renderThreads();
    });

    // =====================
    //  Now On-Air (placeholder)
    //  Hook your existing Live365 logic here if desired.
    // =====================
    function setNowOnAir(text, on){
      const span = el('#nowOnAir');
      span.textContent = text;
      span.style.color = on ? 'white' : 'var(--muted)';
    }
    setNowOnAir('Off Air', false);

    // Start
    bindThreadsListener();
  </script>

  <!-- ===============================
       üîí Firestore Rules (example)
       Paste into Firebase Console > Firestore > Rules
       And adjust to your needs.
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      function signedIn() { return request.auth != null; }
      function isAdmin() { return exists(/databases/$(database)/documents/roles/$(request.auth.uid)) && ("admin" in get(/databases/$(database)/documents/roles/$(request.auth.uid)).data.roles); }
      function isMod() { return exists(/databases/$(database)/documents/roles/$(request.auth.uid)) && ("mod" in get(/databases/$(database)/documents/roles/$(request.auth.uid)).data.roles); }

      match /roles/{uid} {
        allow read: if true; // public so badges work
        allow write: if isAdmin(); // only admins update roles
      }

      match /threads/{id} {
        allow read: if true;
        allow create: if signedIn() && request.resource.data.imageUrl.matches(".*\\.(png|jpg|jpeg|gif|webp)$") &&
          request.resource.data.title is string && request.resource.data.title.size() > 0;
        allow update: if signedIn() && (
          (request.auth.uid == resource.data.authorUid) || isAdmin() || isMod()
        );
        allow delete: if signedIn() && ((request.auth.uid == resource.data.authorUid) || isAdmin() || isMod());
      }

      match /threads/{id}/replies/{rid} {
        allow read: if true;
        allow create: if signedIn() && request.resource.data.imageUrl.matches(".*\\.(png|jpg|jpeg|gif|webp)$");
        allow update, delete: if signedIn() && ((request.auth.uid == resource.data.authorUid) || isAdmin() || isMod());
      }

      match /threads/{id}/likes/{uid} {
        allow read: if true;
        allow create: if signedIn() && request.auth.uid == uid;
        allow delete: if signedIn() && request.auth.uid == uid;
      }
    }
  }
  =============================== -->
</body>
</html>

